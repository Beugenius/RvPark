<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE-edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Rental Spaces</title>
		<link rel="stylesheet" href="css/bootstrap.min.css" />
		<link rel="stylesheet" type="text/css" href="font/bootstrap-icons.css" />
		<script lang="javascript" src="js/bootstrap.min.js"></script>
		<script>
			function checkDates(which) {
				let startDate = new Date(document.getElementById("dateStart").value + "T00:00:00");
				let endDate = new Date(document.getElementById("dateEnd").value + "T00:00:00");
				const today = new Date(document.getElementById("todaysDate").value + "T00:00:00");
				const tomorrow = new Date(document.getElementById("tomorrowsDate").value + "T00:00:00");
				const sixMo1 = new Date(document.getElementById("sixMonths1").value + "T00:00:00");
				const sixMo2 = new Date(document.getElementById("sixMonths2").value + "T00:00:00");
				if (startDate < today || endDate < tomorrow) {
					document.getElementById("dateStart").value = document.getElementById("todaysDate").value;
					document.getElementById("dateEnd").value = document.getElementById("tomorrowsDate").value;
				} else if (startDate > sixMo1 || endDate > sixMo2) {
					document.getElementById("dateStart").value = document.getElementById("sixMonths1").value;
					document.getElementById("dateEnd").value = document.getElementById("sixMonths2").value;
				} else if (startDate >= endDate) {
					if (which == 1) {
						endDate = startDate;
						endDate.setDate(startDate.getDate() + 1);
						let year = endDate.getFullYear();
						let month = endDate.getMonth() + 1;
						let day = endDate.getDate();
						if (month < 10) {
							month = "0" + month;
						}
						if (day < 10) {
							day = "0" + day;
						}
						document.getElementById("dateEnd").value = [year, month, day].join("-");
					} else if (which == 2) {
						startDate = endDate;
						startDate.setDate(endDate.getDate() - 1);
						let year = startDate.getFullYear();
						let month = startDate.getMonth() + 1;
						let day = startDate.getDate();
						if (month < 10) {
							month = "0" + month;
						}
						if (day < 10) {
							day = "0" + day;
						}
						document.getElementById("dateStart").value = [year, month, day].join("-");
					}
				}
			}

			function sizeMap() {
				const campMap = document.getElementById("campMap");
				if (campMap.getAttribute("testAtt") == "0") {
					campMap.setAttribute("testAtt", "1");
					campMap.setAttribute("width", "100%");
					campMap.setAttribute("height", "100%");
				} else if (campMap.getAttribute("testAtt") == "1") {
					campMap.setAttribute("testAtt", "0");
					campMap.setAttribute("width", "250");
					campMap.setAttribute("height", "250");
				}
			}

			function setReserveFormDates(id) {
				const startDate = document.getElementById("dateStart").value; 
				const endDate = document.getElementById("dateEnd").value; 
				document.getElementById(id+"-form-start-date").value = startDate;
				document.getElementById(id+"-form-end-date").value = endDate;
			}
		</script>
	</head>
	<body>
		<%- include('nav'); %>
		<main class="px-3">
            <h3>Camp and Storage Site Availability</h3>
			<div class="rounded d-inline-flex flex-column bg-primary-subtle p-2" onclick="sizeMap()">
				<h5>FamCamp Map (click to expand)</h5>
				<img id="campMap" class="img-fluid" src="/images/famcamp-map.png" width="250" height="250" testAtt="0">
			</div>
            <!-- div class="accordion" id="accordionGroup">
                <div class="accordion-item">
                    <h4 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#campMap" aria-expanded="false" aria-controls="campMap">
                            FamCamp Map
                        </button>
                    </h4>
                    <div id="campMap" class="accordion-collapse collapse" data-bs-parent="#accordionGroup">
                        <div class="accordion-body">
                            <img class="img-fluid mb-4" loading="lazy" src="/images/famcamp-map.png"
                                alt="simplified map of the campground, showing all available sites, buildings, and roads">
                        </div>
                    </div>
                </div>
            </div -->
            <form id="availForm" class="my-2" method="post">
                <div class="my-2">
                    <label for="dateStart">Start date (check in after 1300):</label>
                    <input type="date" id="dateStart" name="dateStart" value="<%- locals.start %>" min="<%- locals.today %>" max="<%- locals.sixMonths1 %>" onblur="checkDates(1)"/>
                </div>
                <div class="my-2">
                    <label for="dateEnd">End date (check out before 1200):</label>
                    <input type="date" id="dateEnd" name="dateEnd" value="<%- locals.end %>" min="<%- locals.tomorrow %>" max="<%- locals.sixMonths2 %>" onblur="checkDates(2)"/>
                </div>
				<div class="my-2">
                    <label for="lengthSelect">Site length:</label>
                    <select id="lengthSelect" name="lengthSelect">
                        <option value="all">All</option>
                        <option value="42" <% if (locals.lengthSelect == '42') { %> selected <% } %> >42 feet</option>
                        <option value="45" <% if (locals.lengthSelect == '45') { %> selected <% } %> >45 feet</option>
                        <option value="55" <% if (locals.lengthSelect == '55') { %> selected <% } %> >55 feet</option>
                        <option value="65" <% if (locals.lengthSelect == '65') { %> selected <% } %> >65 feet</option>
                        <option value="none" <% if (locals.lengthSelect == 'none') { %> selected <% } %> >None</option>
                    </select>
                </div>
                <input type="hidden" id="todaysDate" name="todaysDate" value="<%- locals.today %>"/>
                <input type="hidden" id="tomorrowsDate" name="tomorrowsDate" value="<%- locals.tomorrow %>"/>
                <input type="hidden" id="sixMonths1" name="sixMonths1" value="<%- locals.sixMonths1 %>"/>
                <input type="hidden" id="sixMonths2" name="sixMonths2" value="<%- locals.sixMonths2 %>"/>
                <button type="submit" class="btn btn-primary">Filter</button>
			</form>
			<div class="rounded d-flex justify-content-center m-2">
				<% if (locals.sites.length) { %>
					<table class="table table-striped table-hover">
						<thead>
							<tr>
								<th scope="col">Site</th>
								<th scope="col">Type</th>
								<th scope="col">Length</th>
								<th scope="col">Rate</th>
								<th scope="col">Options</th>
							</tr>
						</thead>
						<tbody>
							<% for (site of locals.sites) { if (site.site_type == "Storage" && locals.session.role != "admin") continue; %>
								<tr>
									<td><%- site.site_name %></td>
									<td><%- site.site_type %></td>
									<td><%- site.site_length_in_feet %></td>
									<td><%- site.rate %></td>
									<td>
										<form id="<%- site.site_id %>-form" action="/reserve" method="post" onsubmit="return setReserveFormDates('<%- site.site_id %>');">
											<input type="hidden" name="siteId" value="<%- site.site_id %>" />
											<input type="hidden" id="<%-site.site_id%>-form-start-date" name="startDate" />
											<input type="hidden" id="<%-site.site_id%>-form-end-date" name="endDate"/>
											<button type="submit" class="btn btn-primary">Reserve</button>
										</form>
									</td>
								</tr>
							<% } %>
						</tbody>
					</table>
				<% } else { %>
					<p class="text-center">No availabilities for the selected date range</p>
				<% } %>
			</div>
		</main>
	</body>
</html>
